<!DOCTYPE html>
<html>

<head>
    <title>Narrative Visualization Final Project</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap.bundle.min.js"></script>
    <script src="d3.min.js"></script>

    <style>
    </style>
</head>

<div class="container-lg">
<body onload='init()'>

<div class="row">
<h3>A Short History of Inflation</h3>
</div>

<div class="row">
<section id="narrative">
    Narrative here.
</section>
</div>

<div class="row">
    <div class="col-1"></div>

    <div class="col-auto">
    <svg width=1000 height=500> </svg>
    </div>

    <div class="col-1"></div>
</div>

<div class="row">

    <div class="col-10">
        <button type="button" class="btn btn-outline-primary" onclick="prevClick()">Prev</button>
        <button type="button" class="btn btn-outline-primary" onclick="nextClick()">Next</button>

    </div>

    <div id="page-div" class="col-1">
        1/5
    </div>

</div>

</div>

</body>
</div>

<script>
let pageCounter = 1;

function init() {
    //cpiFile = 'CPIAPPSL_cpi_apparel.csv';
    cpiFile = 'CPIAUCSL_cpi_all.csv';
    //cpiFile = 'CPIEDUSL_cpi_education_communication.csv';
    //cpiFile = 'CPIFABSL_cpi_food_beverages.csv';
    //cpiFile = 'CPIHOSSL_cpi_housing.csv';
    //cpiFile = 'CPIMEDSL_cpi_medical.csv';
    //cpiFile = 'CPIOGSSL_cpi_other_goods_and_services.csv';
    //cpiFile = 'CPIRECSL_cpi_recreation.csv';
    //cpiFile = 'CPITRNSL_cpi_transportation.csv';


    csvRes = d3.csv(cpiFile, function(data) {
        return { date : d3.timeParse('%Y-%m-%d')(data.DATE), cpi : parseFloat(data.CPI) }
    });
    
    csvRes.then(function(data) {
        calculateInflation(data);
        data = data.filter(
            d => d.date.getFullYear() > 1883 && d.date.getFullYear() < 2022);
        console.log(data);
        setupViz(data);
    });
}

function calculateInflation(data) {
    for (let i = 0; i < data.length; i++) {
        if ((i >= 0) && (i < 12)) {
            data[i]['inflation'] = undefined;
        }
        else {
            data[i]['inflation'] = ((data[i]['cpi'] - data[i-12]['cpi']) / 
                data[i-12]['cpi']) * 100;
        }
    }

    data.splice(0, 12);
}

function setupViz(data) {
    /*
    const data = [
        {date: new Date('2021-01-01'), data: -0.3},
        {date: new Date('2021-02-01'), data: 1},
        {date: new Date('2021-03-01'), data: 2},
        {date: new Date('2021-04-01'), data: 3},
        {date: new Date('2021-05-01'), data: 2.4},
        {date: new Date('2021-06-01'), data: 1.7},
        {date: new Date('2021-07-01'), data: -0.7},
        {date: new Date('2021-08-01'), data: -0.7}
    ];
    */

    const height = 300;
    const width = 800;
    const margin = 50;

    const xScale = d3.scaleTime()
        .domain(d3.extent(data, function(d) { return d.date }))
        .range([0, width]);

    const yScale = d3.scaleLinear()
        .domain([-2, 15])
        .range([height, 0]);

    d3.select('svg')
        .append('g')
            .attr('transform', 'translate(' + margin + ',' + margin + ')')
        .append('path')
            .datum(data)
            .attr('id', 'line-graph')
            .attr('fill', 'none')
            .attr('stroke', 'steelblue')
            .attr('stroke-width', 2)
            .attr('d', d3.line()
                .x(function(d) { return xScale(d.date) })
                .y(function(d) { return yScale(d.inflation) }));

    locale = d3.formatLocale({
        decimal: ".",
        thousands: ",",
        grouping: [3],
        currency: ["$", ""],
        minus: "-"
        });

    d3.select('svg')
        .append('g')
            .attr('transform', 'translate(' + margin + ',' + margin + ')')
        .call(d3.axisLeft(yScale).tickFormat(locale.format('~s')));

    d3.select('svg')
        .append('g')
            .attr('transform', 'translate(' + margin + ',' + (margin + yScale(0)) + ')')
        .call(d3.axisTop(xScale));

}

function updatePage() {
    const cpiFile = 'CPITRNSL_cpi_transportation.csv';

    csvRes = d3.csv(cpiFile, function(data) {
        return { date : d3.timeParse('%Y-%m-%d')(data.DATE), cpi : parseFloat(data.CPI) }
    });
    
    csvRes.then(function(data) {
        calculateInflation(data);
        data = data.filter(
            d => d.date.getFullYear() > 1883 && d.date.getFullYear() < 2022);
        updateLineGraph(data);
    });
}

function updateLineGraph(data) {
    const height = 300;
    const width = 800;
    const margin = 50;

    const xScale = d3.scaleTime()
        .domain(d3.extent(data, function(d) { return d.date }))
        .range([0, width]);

    const yScale = d3.scaleLinear()
        .domain([-2, 15])
        .range([height, 0]);

    d3.select('#line-graph').datum(data).attr('d', d3.line()
        .x(function(d) { return xScale(d.date) })
        .y(function(d) { return yScale(d.inflation) }));
}

function prevClick() {
    if (pageCounter > 1)
        pageCounter--;
    d3.select('#page-div').html(pageCounter + '/5')

    d3.select('#narrative').html('Insert narrative here: ' + pageCounter);

    updatePage();
}

function nextClick() {
    if (pageCounter < 5)
        pageCounter++;
    d3.select('#page-div').html(pageCounter + '/5')

    console.log('next click');
}


</script>


</html>